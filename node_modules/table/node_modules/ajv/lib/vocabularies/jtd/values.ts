<<<<<<< HEAD
import type {CodeKeywordDefinition, SchemaObject} from "../../types"
import type {KeywordCxt} from "../../compile/validate"
import {alwaysValidSchema, Type} from "../../compile/util"
import {not, Name} from "../../compile/codegen"
import {checkMetadata} from "./metadata"
import {checkNullableObject} from "./nullable"
import {typeError, _JTDTypeError} from "./error"

export type JTDValuesError = _JTDTypeError<"values", "object", SchemaObject>
=======
import type {CodeKeywordDefinition} from "../../types"
import type KeywordCxt from "../../compile/context"
import {Type} from "../../compile/subschema"
import {alwaysValidSchema} from "../../compile/util"
import {not, Name} from "../../compile/codegen"
import {checkMetadata} from "./metadata"
import {checkNullableObject} from "./nullable"
>>>>>>> c9839472c444f6ec2829e00bb0169a884834f986

const def: CodeKeywordDefinition = {
  keyword: "values",
  schemaType: "object",
<<<<<<< HEAD
  error: typeError("object"),
=======
>>>>>>> c9839472c444f6ec2829e00bb0169a884834f986
  code(cxt: KeywordCxt) {
    checkMetadata(cxt)
    const {gen, data, schema, it} = cxt
    if (alwaysValidSchema(it, schema)) return
    const [valid, cond] = checkNullableObject(cxt, data)
<<<<<<< HEAD
    gen.if(cond)
    gen.assign(valid, validateMap())
    gen.elseIf(not(valid))
    cxt.error()
    gen.endIf()
    cxt.ok(valid)
=======
    gen.if(cond, () => gen.assign(valid, validateMap()))
    cxt.pass(valid)
>>>>>>> c9839472c444f6ec2829e00bb0169a884834f986

    function validateMap(): Name | boolean {
      const _valid = gen.name("valid")
      if (it.allErrors) {
        const validMap = gen.let("valid", true)
        validateValues(() => gen.assign(validMap, false))
        return validMap
      }
      gen.var(_valid, true)
      validateValues(() => gen.break())
      return _valid

      function validateValues(notValid: () => void): void {
        gen.forIn("key", data, (key) => {
          cxt.subschema(
            {
              keyword: "values",
              dataProp: key,
              dataPropType: Type.Str,
            },
            _valid
          )
          gen.if(not(_valid), notValid)
        })
      }
    }
  },
}

export default def
